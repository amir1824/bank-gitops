apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mainframe-mock.fullname" . }}-code
  labels:
    {{- include "mainframe-mock.labels" . | nindent 4 }}
data:
  server.py: |
    #!/usr/bin/env python3
    """
    Mizrahi Bank - Mainframe Mock Service
    
    A simple HTTP server that simulates legacy mainframe responses.
    Designed to run as non-root user in OpenShift environments.
    """
    
    import json
    import logging
    import os
    from http.server import HTTPServer, BaseHTTPRequestHandler
    from datetime import datetime
    
    # Configure logging
    LOG_LEVEL = os.getenv('LOG_LEVEL', 'INFO')
    logging.basicConfig(
        level=getattr(logging, LOG_LEVEL),
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    logger = logging.getLogger('mainframe-mock')
    
    
    class MainframeHandler(BaseHTTPRequestHandler):
        """HTTP request handler for mainframe mock service."""
        
        def do_GET(self):
            """Handle GET requests."""
            logger.info(f"GET {self.path} from {self.client_address[0]}")
            
            if self.path == '/health':
                self.send_health_response()
            elif self.path == '/status':
                self.send_status_response()
            elif self.path.startswith('/account/'):
                self.send_account_response()
            else:
                self.send_default_response()
        
        def do_POST(self):
            """Handle POST requests."""
            content_length = int(self.headers.get('Content-Length', 0))
            body = self.rfile.read(content_length).decode('utf-8')
            
            logger.info(f"POST {self.path} from {self.client_address[0]}")
            logger.debug(f"Request body: {body}")
            
            if self.path == '/transaction':
                self.send_transaction_response()
            else:
                self.send_default_response()
        
        def send_health_response(self):
            """Health check endpoint."""
            response = {
                "status": "healthy",
                "service": "mainframe-mock",
                "timestamp": datetime.utcnow().isoformat()
            }
            self.send_json_response(200, response)
        
        def send_status_response(self):
            """Status endpoint - primary response."""
            response = {
                "status": "Legacy System Online",
                "version": "1.0.0",
                "uptime": "operational",
                "timestamp": datetime.utcnow().isoformat()
            }
            self.send_json_response(200, response)
        
        def send_account_response(self):
            """Mock account lookup response."""
            account_id = self.path.split('/')[-1]
            response = {
                "status": "success",
                "account_id": account_id,
                "balance": 12345.67,
                "currency": "ILS",
                "account_type": "checking",
                "timestamp": datetime.utcnow().isoformat()
            }
            self.send_json_response(200, response)
        
        def send_transaction_response(self):
            """Mock transaction processing response."""
            response = {
                "status": "processed",
                "transaction_id": "TXN-" + datetime.utcnow().strftime("%Y%m%d%H%M%S"),
                "result": "approved",
                "timestamp": datetime.utcnow().isoformat()
            }
            self.send_json_response(200, response)
        
        def send_default_response(self):
            """Default response for unknown endpoints."""
            response = {
                "status": "Legacy System Online",
                "message": "Mainframe mock service is running",
                "endpoints": ["/health", "/status", "/account/{id}", "/transaction"],
                "timestamp": datetime.utcnow().isoformat()
            }
            self.send_json_response(200, response)
        
        def send_json_response(self, status_code, data):
            """Send JSON response with proper headers."""
            self.send_response(status_code)
            self.send_header('Content-Type', 'application/json')
            self.send_header('X-Service', 'Mizrahi-Mainframe-Mock')
            self.end_headers()
            self.wfile.write(json.dumps(data, indent=2).encode('utf-8'))
        
        def log_message(self, format, *args):
            """Override to use custom logger."""
            logger.info(f"{self.client_address[0]} - {format % args}")
    
    
    def run_server(port=8080):
        """Start the HTTP server."""
        server_address = ('', port)
        httpd = HTTPServer(server_address, MainframeHandler)
        
        logger.info(f"Starting Mainframe Mock Server on port {port}")
        logger.info(f"Running as UID: {os.getuid()}, GID: {os.getgid()}")
        logger.info("Press Ctrl+C to stop the server")
        
        try:
            httpd.serve_forever()
        except KeyboardInterrupt:
            logger.info("Server stopped by user")
        except Exception as e:
            logger.error(f"Server error: {e}")
            raise
        finally:
            httpd.server_close()
            logger.info("Server shutdown complete")
    
    
    if __name__ == '__main__':
        port = int(os.getenv('SERVER_PORT', 8080))
        run_server(port)
